// Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„
class AuthManager {
    constructor() {
        this.currentUser = this.getCurrentUser();
    }
    
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    login(email, password) {
        // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                // Ù‡Ù†Ø§ Ø³ÙŠØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
                const users = JSON.parse(localStorage.getItem('soug_users') || '[]');
                const user = users.find(u => 
                    (u.email === email || u.phone === email) && u.password === password
                );
                
                if (user) {
                    this.currentUser = user;
                    localStorage.setItem('soug_user', JSON.stringify(user));
                    resolve(user);
                } else {
                    reject('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                }
            }, 1000);
        });
    }
    
    // ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
    register(userData) {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                const users = JSON.parse(localStorage.getItem('soug_users') || '[]');
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙØ³ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ
                const exists = users.some(u => 
                    u.email === userData.email || u.phone === userData.phone
                );
                
                if (exists) {
                    reject('Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
                    return;
                }
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const newUser = {
                    id: Date.now(),
                    ...userData,
                    createdAt: new Date().toISOString(),
                    role: 'user'
                };
                
                users.push(newUser);
                localStorage.setItem('soug_users', JSON.stringify(users));
                localStorage.setItem('soug_user', JSON.stringify(newUser));
                
                this.currentUser = newUser;
                resolve(newUser);
            }, 1500);
        });
    }
    
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    logout() {
        this.currentUser = null;
        localStorage.removeItem('soug_user');
        showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        window.location.reload();
    }
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    getCurrentUser() {
        const user = localStorage.getItem('soug_user');
        return user ? JSON.parse(user) : null;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    isLoggedIn() {
        return this.currentUser !== null;
    }
}

// Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
const auth = new AuthManager();

// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
async function handleLogin() {
    const form = document.getElementById('loginForm');
    const email = form.querySelector('input[type="text"]').value;
    const password = form.querySelector('input[type="password"]').value;
    
    try {
        showNotification('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...', 'info');
        const user = await auth.login(email, password);
        
        showNotification(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user.name} ğŸ‘‹`, 'success');
        closeLoginModal();
        
        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        updateUIAfterLogin(user);
        
    } catch (error) {
        showNotification(error, 'error');
    }
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
async function handleRegister() {
    const form = document.getElementById('registerForm');
    const inputs = form.querySelectorAll('input');
    
    const userData = {
        name: inputs[0].value,
        phone: inputs[1].value,
        email: inputs[2].value,
        password: inputs[3].value
    };
    
    try {
        showNotification('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ...', 'info');
        const user = await auth.register(userData);
        
        showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰', 'success');
        closeRegisterModal();
        
        updateUIAfterLogin(user);
        
    } catch (error) {
        showNotification(error, 'error');
    }
}

// ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
function updateUIAfterLogin(user) {
    const authButtons = document.querySelector('.auth-buttons');
    const userMenu = document.querySelector('.user-menu');
    
    if (authButtons) {
        authButtons.innerHTML = `
            <div class="user-dropdown">
                <button class="btn btn-outline" onclick="toggleUserMenu()">
                    <i class="fas fa-user"></i> ${user.name.split(' ')[0]}
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu" id="userDropdown">
                    <a href="pages/dashboard.html"><i class="fas fa-tachometer-alt"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
                    <a href="pages/my-ads.html"><i class="fas fa-ad"></i> Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙŠ</a>
                    <a href="pages/messages.html"><i class="fas fa-comments"></i> Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</a>
                    <a href="pages/profile.html"><i class="fas fa-user-cog"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</a>
                    <hr>
                    <a href="#" onclick="auth.logout()"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
                </div>
            </div>
        `;
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø³ØªØ§ÙŠÙ„ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
    const style = document.createElement('style');
    style.textContent = `
        .user-dropdown {
            position: relative;
        }
        
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            min-width: 200px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-radius: 10px;
            padding: 10px 0;
            z-index: 1000;
        }
        
        .dropdown-menu a {
            display: block;
            padding: 10px 20px;
            color: #333;
            text-decoration: none;
            transition: background 0.3s;
        }
        
        .dropdown-menu a:hover {
            background: #f8f9fa;
        }
        
        .dropdown-menu hr {
            margin: 10px 0;
            border: none;
            border-top: 1px solid #eee;
        }
    `;
    document.head.appendChild(style);
}

// ØªØ¨Ø¯ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
function toggleUserMenu() {
    const dropdown = document.getElementById('userDropdown');
    if (dropdown) {
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }
}

// Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
document.addEventListener('click', (e) => {
    const dropdown = document.getElementById('userDropdown');
    const toggleBtn = document.querySelector('.user-dropdown button');
    
    if (dropdown && toggleBtn && 
        !dropdown.contains(e.target) && 
        !toggleBtn.contains(e.target)) {
        dropdown.style.display = 'none';
    }
});

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', () => {
    if (auth.isLoggedIn()) {
        updateUIAfterLogin(auth.currentUser);
    }
});